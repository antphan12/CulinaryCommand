stages:
    - frontend-verify
    # - backend-verify # temporarily disabled while 
    - build
    - deploy

ping-frontend:
    stage: frontend-verify
    tags:
        - frontend
    script:
        - echo "hello frontend!"

# ping-backend:
#     stage: backend-verify
#     tags:
#         - backend
#     script:
#         - echo "backend backend backend"

build-app:
  stage: build
  tags:
    - frontend
  script:
    - echo "Building CulinaryCommand..."
    - dotnet clean
    - dotnet restore
    - dotnet build --configuration Release
    - dotnet publish ./CulinaryCommand.csproj -c Release -o publish-temp/
  artifacts:
    paths:
      - publish-temp/
    expire_in: 1 hour 

# deploy to IIS
deploy-app:
  stage: deploy
  tags:
    - frontend
  script:
    - echo "Deploying to IIS..."
    - powershell -NoProfile -Command "
      Import-Module WebAdministration;
      

      Stop-WebAppPool -Name 'CulinaryCommand' -ErrorAction SilentlyContinue;
      Start-Sleep -Seconds 5;
      

      taskkill /F /IM w3wp.exe /T 2>$null;
      Start-Sleep -Seconds 3;
      

      $processesUsingDll = Get-Process | Where-Object { 
        try { $_.Modules.FileName -like '*CulinaryCommand*' } catch { $false }
      };
      if ($processesUsingDll) {
        $processesUsingDll | Stop-Process -Force;
        Start-Sleep -Seconds 2;
      }
      

      Copy-Item -Recurse -Force 'publish-temp\*' 'C:\Users\vm-user\CulinaryCommand\publish\';
      

      Start-WebAppPool -Name 'CulinaryCommand';
      
      Write-Host 'Deployment completed successfully';
      "
  dependencies:
    - build-app