@page "/purchase-orders/create"
@using CulinaryCommand.PurchaseOrder.DTOs
@using CulinaryCommand.PurchaseOrder.Services
@using CulinaryCommand.Inventory.Entities
@using Microsoft.EntityFrameworkCore
@inject NavigationManager Nav
@inject IPurchaseOrderService PurchaseOrderService
@inject CulinaryCommand.Data.AppDbContext Db

<h3 class="mb-4">Create Purchase Order</h3>

<div class="card">
    <div class="card-body">
        <EditForm Model="@model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">PO Number</label>
                    <InputText class="form-control" @bind-Value="model.PoNumber" placeholder="PO-2025-XXX" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Date</label>
                    <InputDate class="form-control" @bind-Value="model.Date" />
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Supplier</label>
                    <InputText class="form-control" @bind-Value="model.Supplier" placeholder="Supplier name" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Status</label>
                    <InputSelect class="form-select" @bind-Value="model.Status">
                        <option value="">-- Select Status --</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Completed">Completed</option>
                    </InputSelect>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Notes</label>
                <InputTextArea class="form-control" @bind-Value="model.Notes" rows="3" placeholder="Additional notes..." />
            </div>

            <h5 class="mt-4 mb-3">Line Items</h5>
            
            @foreach (var item in model.LineItems)
            {
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Ingredient</label>
                                <InputSelect class="form-select" @bind-Value="item.IngredientId">
                                    <option value="0">-- Select Ingredient --</option>
                                    @foreach (var ing in _ingredients)
                                    {
                                        <option value="@ing.Id">@ing.Name</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Quantity</label>
                                <InputNumber class="form-control" @bind-Value="item.Quantity" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Unit</label>
                                <InputSelect class="form-select" @bind-Value="item.UnitId">
                                    <option value="0">-- Select Unit --</option>
                                    @foreach (var u in _units)
                                    {
                                        <option value="@u.Id">@u.Abbreviation</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Price</label>
                                <InputNumber class="form-control" @bind-Value="item.UnitPrice" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Subtotal</label>
                                <input type="text" class="form-control" value="@item.Subtotal.ToString("C")" readonly />
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger mt-2" @onclick="() => RemoveLineItem(item)">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    </div>
                </div>
            }

            <button type="button" class="btn btn-secondary mb-3" @onclick="AddLineItem">
                <i class="bi bi-plus-circle"></i> Add Line Item
            </button>

            <div class="alert alert-info mt-3">
                <strong>Total: @CalculateTotal().ToString("C")</strong>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-success me-2">
                    <i class="bi bi-save"></i> Save Purchase Order
                </button>
                <button type="button" class="btn btn-secondary" @onclick="Cancel">
                    Cancel
                </button>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger mt-3">
                    @_errorMessage
                </div>
            }
        </EditForm>
    </div>
</div>

@code {
    private PurchaseOrderModel model = new();
    private string? _errorMessage;
    private List<Ingredient> _ingredients = new();
    private List<Unit> _units = new();

    protected override async Task OnInitializedAsync()
    {
        model.Date = DateTime.Now;
        model.Status = "Pending";
        model.LineItems.Add(new LineItemModel());

        _ingredients = await Db.Ingredients
            .OrderBy(i => i.Name)
            .ToListAsync();

        _units = await Db.Units
            .OrderBy(u => u.Abbreviation)
            .ToListAsync();
    }

    private void AddLineItem()
    {
        model.LineItems.Add(new LineItemModel());
    }

    private void RemoveLineItem(LineItemModel item)
    {
        model.LineItems.Remove(item);
    }

    private decimal CalculateTotal()
    {
        return model.LineItems.Sum(x => x.Subtotal);
    }

    private async Task HandleSubmit()
    {
        _errorMessage = null;

        try
        {
            var request = new CreatePurchaseOrderDTO
            {
                LocationId = 5, // TODO: replace with selected location
                VendorName = model.Supplier,
                VendorContact = null,
                ExpectedDeliveryDate = model.Date,
                Notes = model.Notes,
                Lines = model.LineItems
                    .Select(li => new CreatePurchaseOrderLineDTO
                    {
                        IngredientId = li.IngredientId,
                        UnitId = li.UnitId,
                        QuantityOrdered = li.Quantity,
                        UnitPrice = li.UnitPrice
                    })
                    .ToList()
            };

            var created = await PurchaseOrderService.CreateDraftAsync(request);
            @* Nav.NavigateTo($"/purchase-orders/{created.Id}"); *@
            Nav.NavigateTo("/purchase-orders");
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private void Cancel()
    {
        Nav.NavigateTo("/purchase-orders");
    }

    private class PurchaseOrderModel
    {
        public string PoNumber { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public string Supplier { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string Notes { get; set; } = string.Empty;
        public List<LineItemModel> LineItems { get; set; } = new();
    }

    private class LineItemModel
    {
        public int IngredientId { get; set; }
        public int Quantity { get; set; } = 1;
        public int UnitId { get; set; }
        public decimal UnitPrice { get; set; }
        public decimal Subtotal => Quantity * UnitPrice;
    }
}
